<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>QR Scanner Demo</title>

    <!-- mobile-friendly viewport -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />

    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }
      video {
        width: 100%;
        max-width: 600px; /* desktop cap */
        height: auto;
        background: #000;
      }
    </style>
  </head>

  <body>
    <h1>QR Scanner Demo</h1>

    <!-- playsinline + webkit-playsinline keep it inline on iOS -->
    <video id="qr-video" playsinline webkit-playsinline muted autoplay></video>

    <button id="start-btn" hidden>Start camera</button>

    <script type="module">
      // import cloneDeep from "https://cdn.jsdelivr.net/npm/lodash-es@4.17.21/cloneDeep.js";
      import {
        createQrScanner,
        Runner,
        readCoseContent,
      } from "./dist/secure-qr-scanner.es.js";

      const video = document.getElementById("qr-video");
      const startBtn = document.getElementById("start-btn");

      async function openCamera() {
        // first try rear camera
        const constraints = {
          video: {
            facingMode: { ideal: "environment" }, // iOS 14+ & modern Android
            width: { ideal: 640 },
            height: { ideal: 480 },
          },
        };

        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          await video.play(); // iOS needs an explicit play()
          startBtn.hidden = true;
          // fire up your QR scanner once video is ready
          const chain = new Runner()
            .execute(readCoseContent, {
              jwkBase: "https://d2hnybskbnod8e.cloudfront.net/",
            });
          const entries = [{ pattern: "QR1:", securityChain: chain }];
          console.log(entries);
          createQrScanner(video, async (res) => {
            const check = entries[0].securityChain; //pickSecurityEntry(securityChain, text);
            console.log(check);
            let result;
            if (check) result = await check.with({ text: res }).run();
            console.log(result);
          });
        } catch (err) {
          // fallback: try default camera without facingMode
          if (constraints.video.facingMode) {
            delete constraints.video.facingMode;
            try {
              const stream = await navigator.mediaDevices.getUserMedia(
                constraints
              );
              video.srcObject = stream;
              await video.play();
              startBtn.hidden = true;
              createQrScanner(video, (res) => console.log("âœ… Scanned:", res));
              return;
            } catch (e) {
              console.error("Camera error:", e);
            }
          } else {
            console.error("Camera error:", err);
          }
          startBtn.hidden = false;
        }
      }

      // Some mobile browsers block autoplay until a gesture
      // Try immediately, else fall back to a tap
      openCamera();

      startBtn.addEventListener("click", () => openCamera());
    </script>
  </body>
</html>
